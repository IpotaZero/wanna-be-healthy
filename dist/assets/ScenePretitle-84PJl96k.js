const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./SceneNovel-Cy-DZ5z6.js","../run.js"])))=>i.map(i=>d[i]);
import{S as o,B as n,_ as y,a as l,A as c}from"../run.js";class d{#e=[];#t;#s;#a={};currentPage;ready;before=()=>{};after=()=>{};constructor(t,e,s){this.#t=t,this.#t.innerHTML=s,this.#s=Array.from(t.querySelectorAll(".page")),this.ready=this.#r(e)}on(t,e){this.#a[t]=e}async#r(t){await this.#n(t),this.#h(),this.#o()}async#n(t){const e=t.split(" ");this.#e.push(...e.slice(0,-1),e.at(-1)),await this.#i(e.at(-1),!0)}#o(){this.#t.querySelectorAll("[data-link]").forEach(t=>{const e=t.hasAttribute("data-immediately"),s=t.hasAttribute("data-sever"),i=t.getAttribute("data-link");t.addEventListener("click",()=>{s&&(this.#e=[]),this.#e.push(i),this.#i(i,e)})})}#h(){this.#t.querySelectorAll("[data-back]").forEach(t=>{const e=t.hasAttribute("data-immediately"),s=Number.parseInt(t.getAttribute("data-back"));if(isNaN(s)||s<=0){console.warn("正しくないdata-back！",t);return}t.addEventListener("click",()=>{if(this.#e.length<=s){console.warn("戻る履歴がない",t);return}this.#e.splice(-s);const i=this.#e[this.#e.length-1];this.#i(i,e)})})}async#i(t,e){const s=this.#t.querySelector(t);if(!s)throw new Error(`そんなpageは無い: ${t}`);this.#c(),this.before(),e||await this.#d(),this.#s.forEach(i=>i.classList.toggle("hidden",i!==s)),this.currentPage=s,requestAnimationFrame(()=>{requestAnimationFrame(()=>{Object.entries(this.#a).forEach(([i,a])=>{t.match(i)&&a()}),this.#l(),this.after()})})}#c(){this.#t.querySelectorAll("button").forEach(t=>{t.disabled=!0})}#l(){this.#t.querySelectorAll("button").forEach(t=>{t.disabled=!1})}#d(){return new Promise(t=>{this.#t.style.transition="opacity 200ms",this.#t.style.opacity="0",this.#t.style.pointerEvents="none",setTimeout(()=>{this.#t.style.opacity="1",this.#t.style.pointerEvents="",t()},200)})}}class u{async end(){}}class p{#e=new AbortController;#t=0;#s=[];#a=new Set;direction;isAvailable=!0;constructor(t){this.direction=t,this.update(),window.addEventListener("keydown",this.#o,{signal:this.#e.signal}),window.addEventListener("keyup",this.#h,{signal:this.#e.signal})}update(){this.#s=Array.from(document.querySelectorAll("button")).filter(this.#r);const t=this.#s.findIndex(e=>e.classList.contains("selected"));this.#t=Math.max(t,0),this.#n(),this.#i()}discard(){this.#e.abort()}#r=t=>{for(;t;){const e=getComputedStyle(t);if(e.display==="none"||e.visibility==="hidden")return!1;t=t.parentElement}return!0};#n(){this.#s.forEach((t,e)=>{t.onmouseover=()=>{this.#t=e,this.#i()}})}#o=t=>{if(!this.isAvailable||this.#a.has(t.code))return;this.#a.add(t.code),o.key.play();const e=this.#s.length;if(e===0)return;const s=this.direction==="horizontal"?"ArrowRight":"ArrowDown",i=this.direction==="horizontal"?"ArrowLeft":"ArrowUp";t.code===s?(this.#t=(this.#t+1)%e,this.#i()):t.code===i?(this.#t=(this.#t+e-1)%e,this.#i()):["Enter","Space","KeyZ"].includes(t.code)?this.#s[this.#t].click():["Escape","Backspace","KeyX"].includes(t.code)&&this.#s.find(a=>a.hasAttribute("data-back"))?.click()};#h=t=>{this.#a.delete(t.code)};#i(){this.#s.forEach((t,e)=>{t.classList.toggle("selected",e===this.#t),e===this.#t&&t.focus()})}}class f{constructor(t,e,s){this.canvas=t,this.gainNode=e,this.ctx=t.getContext("2d"),this.analyser=s.createAnalyser(),this.analyser.fftSize=2048,this.bufferLength=this.analyser.fftSize,this.dataArray=new Uint8Array(this.bufferLength),this.gainNode.connect(this.analyser)}ctx;analyser;dataArray;bufferLength;update(){this.analyser.getByteTimeDomainData(this.dataArray);const{width:t,height:e}=this.canvas;this.ctx.clearRect(0,0,t,e),this.ctx.lineWidth=2,this.ctx.strokeStyle="#888",this.ctx.beginPath();const s=t/this.bufferLength;let i=0;for(let a=0;a<this.bufferLength;a++){const h=this.dataArray[a]/128*e/2;a===0?this.ctx.moveTo(i,h):this.ctx.lineTo(i,h),i+=s}this.ctx.lineTo(t,e/2),this.ctx.stroke()}}class g{page;constructor(t){this.page=t,window.addEventListener("keydown",this.#e.bind(this))}#e(t){t.key==="ArrowDown"?(this.page.scrollBy({top:this.#t(),behavior:"instant"}),t.preventDefault()):t.key==="ArrowUp"&&(this.page.scrollBy({top:-this.#t(),behavior:"instant"}),t.preventDefault())}#t(){const t=getComputedStyle(this.page).fontSize;return parseFloat(t)||16}discard(){window.removeEventListener("keydown",this.#e)}}class m extends u{ready;#e;#t;#s;#a;#r;#n=performance.now();constructor(){super(),this.ready=this.#o()}async#o(){const t=document.getElementById("container"),e=await fetch("./pages/title.html").then(i=>i.text());this.#s=new d(t,"#normal",e),await this.#s.ready,await n.fetch("assets/sounds/title.mp3",{loopStart:42,volume:2}),n.play();const s=t.querySelector("canvas");this.#a=new f(s,n.gain,n.context),this.#s.after=()=>{this.#e.update(),this.#t.page=this.#s.currentPage},this.#e=new p("horizontal"),this.#t=new g(this.#s.currentPage),this.#h(),this.#r=setInterval(this.#i.bind(this))}#h(){document.querySelector("#game").onclick=async()=>{const{SceneNovel:t}=await y(async()=>{const{SceneNovel:e}=await import("./SceneNovel-Cy-DZ5z6.js");return{SceneNovel:e}},__vite__mapDeps([0,1]),import.meta.url);n.fadeOut(1e3),l.goto(()=>new t,{msIn:1e3,msOut:1e3})}}async end(){this.#e.discard(),this.#t.discard(),clearInterval(this.#r)}#i(){performance.now()-this.#n>=25500&&this.#a.update()}}class w extends u{ready;#e;constructor(){super(),this.ready=this.#t()}async#t(){const t=document.getElementById("container"),e=await fetch("./pages/pretitle.html").then(s=>s.text());this.#e=new d(t,"#pretitle",e),this.#s()}async#s(){await c.ok(),o.key.play(),await c.sleep(o.key.duration*1e3),o.MCR.play(),l.goto(()=>new m,{msIn:2e3,msOut:1e3})}}const A=Object.freeze(Object.defineProperty({__proto__:null,ScenePretitle:w},Symbol.toStringTag,{value:"Module"}));export{d as P,u as S,m as a,A as b};
//# sourceMappingURL=ScenePretitle-84PJl96k.js.map
