{"version":3,"file":"SceneTitle-AEpfF1sO.js","sources":["../../src/utils/KeyDriver.ts","../../src/utils/Pages.ts","../../src/Scenes/Scene.ts","../../src/Scenes/SceneTitle.ts"],"sourcesContent":["export class KeyDriver {\r\n    #index = 0\r\n    #buttons: HTMLButtonElement[] = []\r\n    #signal = new AbortController()\r\n\r\n    direction: \"horizontal\" | \"vertical\"\r\n\r\n    constructor(direction: \"horizontal\" | \"vertical\") {\r\n        this.direction = direction\r\n        this.update()\r\n    }\r\n\r\n    update() {\r\n        this.#signal.abort()\r\n\r\n        this.#buttons = [...document.querySelectorAll(\"button\")].filter((b) => this.#isElementVisible(b))\r\n\r\n        const selectedIndex = this.#buttons.findIndex((b) => b.classList.contains(\"selected\"))\r\n        this.#index = Math.max(selectedIndex, 0)\r\n\r\n        this.#signal = new AbortController()\r\n        window.addEventListener(\"keydown\", this.#handler.bind(this), { signal: this.#signal.signal })\r\n        this.#setupHover()\r\n        this.#updateButtonClass()\r\n    }\r\n\r\n    discard() {\r\n        this.#signal.abort()\r\n    }\r\n\r\n    #isElementVisible(el: Element): boolean {\r\n        while (el) {\r\n            const style = getComputedStyle(el)\r\n            if (style.display === \"none\" || style.visibility === \"hidden\" || style.opacity === \"0\") {\r\n                return false\r\n            }\r\n\r\n            if (!el.parentElement) return true\r\n\r\n            el = el.parentElement\r\n        }\r\n\r\n        return true\r\n    }\r\n\r\n    #setupHover() {\r\n        this.#buttons.forEach((b, i) => {\r\n            b.onmouseover = () => {\r\n                this.#index = i\r\n                this.#updateButtonClass()\r\n            }\r\n        })\r\n    }\r\n\r\n    #handler(e: KeyboardEvent) {\r\n        const l = this.#buttons.length\r\n\r\n        const next = this.direction === \"horizontal\" ? \"ArrowRight\" : \"ArrowDown\"\r\n        const back = this.direction === \"horizontal\" ? \"ArrowLeft\" : \"ArrowUp\"\r\n\r\n        if (e.code === next) {\r\n            this.#index = (this.#index + 1) % l\r\n            this.#updateButtonClass()\r\n        }\r\n\r\n        if (e.code === back) {\r\n            this.#index = (this.#index + l - 1) % l\r\n            this.#updateButtonClass()\r\n        }\r\n\r\n        if ([\"Enter\", \"Space\", \"KeyZ\"].includes(e.code)) {\r\n            this.#buttons[this.#index].click()\r\n        }\r\n\r\n        if ([\"Escape\", \"Backspace\", \"KeyX\"].includes(e.code)) {\r\n            this.#buttons.find((b) => b.hasAttribute(\"data-back\"))?.click()\r\n        }\r\n    }\r\n\r\n    #updateButtonClass() {\r\n        this.#buttons.forEach((button, i) => {\r\n            button.classList.toggle(\"selected\", i === this.#index)\r\n            if (i === this.#index) button.focus()\r\n        })\r\n    }\r\n}\r\n","export class Pages {\r\n    #history: string[] = []\r\n    #container: HTMLElement\r\n    #pages: Element[]\r\n\r\n    #handlers: { [k: string]: () => void } = {}\r\n\r\n    constructor(container: HTMLElement, firstPageSelector: string, html: string) {\r\n        this.#container = container\r\n        this.#container.innerHTML = html\r\n\r\n        this.#pages = [...container.querySelectorAll(\".page\")]\r\n\r\n        this.#setupFirstPage(firstPageSelector)\r\n        this.#setupBackButtons()\r\n        this.#setupLinkButtons()\r\n    }\r\n\r\n    on(selector: string, handler: () => void) {\r\n        this.#handlers[selector] = handler\r\n    }\r\n\r\n    #setupFirstPage(firstPageSelector: string) {\r\n        const currentPageSegments = firstPageSelector.split(\" \")\r\n\r\n        this.#history.push(...currentPageSegments.slice(0, -1))\r\n        this.#history.push(currentPageSegments.at(-1)!)\r\n        this.#changePage(currentPageSegments.at(-1)!, true)\r\n    }\r\n\r\n    #setupLinkButtons() {\r\n        const linkButtons = this.#container.querySelectorAll(\"[data-link]\")\r\n\r\n        linkButtons.forEach((linkButton) => {\r\n            const immediately = linkButton.hasAttribute(\"data-immediately\")\r\n            const sever = linkButton.hasAttribute(\"data-sever\")\r\n            const targetPageId = linkButton.getAttribute(\"data-link\")!\r\n\r\n            linkButton.addEventListener(\"click\", () => {\r\n                if (sever) this.#history = []\r\n\r\n                this.#history.push(targetPageId)\r\n\r\n                this.#changePage(targetPageId, immediately)\r\n            })\r\n        })\r\n    }\r\n\r\n    #setupBackButtons() {\r\n        const backButtons = this.#container.querySelectorAll(\"[data-back]\")\r\n\r\n        backButtons.forEach((backButton) => {\r\n            const immediately = backButton.hasAttribute(\"data-immediately\")\r\n            const backAttr = backButton.getAttribute(\"data-back\")!\r\n\r\n            const backDepth = Number.parseInt(backAttr)\r\n\r\n            if (Number.isNaN(backDepth) || backDepth <= 0) {\r\n                console.warn(\"正しくないdata-back！\", backButton)\r\n                return\r\n            }\r\n\r\n            backButton.addEventListener(\"click\", () => {\r\n                if (this.#history.length <= backDepth) {\r\n                    console.warn(\"戻る履歴がない\", backButton)\r\n                    return\r\n                }\r\n\r\n                let previousPageId = \"\"\r\n\r\n                for (let i = 0; i < backDepth; i++) {\r\n                    this.#history.pop()\r\n                    previousPageId = this.#history[this.#history.length - 1]\r\n                }\r\n\r\n                this.#changePage(previousPageId, immediately)\r\n            })\r\n        })\r\n    }\r\n\r\n    async #changePage(pageSelector: string, immediately: boolean) {\r\n        const targetPage = this.#container.querySelector(pageSelector)\r\n\r\n        if (!targetPage) {\r\n            throw new Error(`そんなpageは無い: ${pageSelector}`)\r\n        }\r\n\r\n        if (!immediately) {\r\n            await new Promise((resolve) => {\r\n                this.#container.style.transition = \"opacity 200ms\"\r\n                this.#container.style.opacity = \"0\"\r\n                this.#container.style.pointerEvents = \"none\"\r\n\r\n                setTimeout(resolve, 200)\r\n            })\r\n\r\n            this.#container.style.opacity = \"1\"\r\n            this.#container.style.pointerEvents = \"\"\r\n        }\r\n\r\n        this.#pages.forEach((page) => {\r\n            page.classList.toggle(\"hidden\", page !== targetPage)\r\n        })\r\n\r\n        requestAnimationFrame(() => {\r\n            requestAnimationFrame(() => {\r\n                Object.entries(this.#handlers).forEach(([key, value]) => {\r\n                    if (pageSelector.match(key)) {\r\n                        value()\r\n                    }\r\n                })\r\n            })\r\n        })\r\n    }\r\n}\r\n","export abstract class Scene {\r\n    abstract ready: Promise<void>\r\n    end() {}\r\n}\r\n","import { KeyDriver } from \"../utils/KeyDriver.js\"\r\nimport { Pages } from \"../utils/Pages.js\"\r\nimport { Scene } from \"./Scene.js\"\r\n\r\nexport class SceneTitle extends Scene {\r\n    ready: Promise<void>\r\n    #keyDriver!: KeyDriver\r\n    #pages!: Pages\r\n\r\n    constructor() {\r\n        super()\r\n\r\n        this.ready = this.#setup()\r\n    }\r\n\r\n    async #setup() {\r\n        const container = document.getElementById(\"container\")!\r\n\r\n        const html = await fetch(\"./pages/title.html\").then((response) => response.text())\r\n        this.#pages = new Pages(container, \"#normal\", html)\r\n\r\n        this.#pages.on(\".*\", () => {\r\n            this.#keyDriver.update()\r\n        })\r\n\r\n        this.#keyDriver = new KeyDriver(\"horizontal\")\r\n    }\r\n\r\n    end(): void {\r\n        this.#keyDriver.discard()\r\n    }\r\n}\r\n"],"names":["KeyDriver","#index","#buttons","#signal","direction","b","#isElementVisible","selectedIndex","#handler","#setupHover","#updateButtonClass","el","style","i","l","next","back","button","Pages","#history","#container","#pages","#handlers","container","firstPageSelector","html","#setupFirstPage","#setupBackButtons","#setupLinkButtons","selector","handler","currentPageSegments","#changePage","linkButton","immediately","sever","targetPageId","backButton","backAttr","backDepth","previousPageId","pageSelector","targetPage","resolve","page","key","value","Scene","SceneTitle","#keyDriver","#setup","response"],"mappings":"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"}